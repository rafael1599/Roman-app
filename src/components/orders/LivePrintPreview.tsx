import React, { useMemo } from 'react';
import jsPDF from 'jspdf';

interface LivePrintPreviewProps {
    orderNumber?: string;
    customerName: string;
    street: string;
    city: string;
    state: string;
    zip: string;
    pallets: number | string;
    units: number | string;
    loadNumber: string;
    completedAt?: string;
}

export const LivePrintPreview: React.FC<LivePrintPreviewProps> = ({
    orderNumber,
    customerName,
    street,
    city,
    state,
    zip,
    pallets,
    units,
    loadNumber,
    completedAt
}) => {
    const palletCount = parseInt(pallets?.toString() || '1');
    const cityStateZip = `${city}, ${state} ${zip}`.toUpperCase().trim();

    // Replicate PDF Scaling Logic from Production
    const fontSizePt = useMemo(() => {
        const margin = 5;
        const pageWidth = 297;
        const pageHeight = 210;
        const PT_TO_MM = 0.3528;
        const LINE_HEIGHT = 1.1;
        const maxWidth = pageWidth - margin * 2;
        const maxHeight = pageHeight - margin * 2;
        const thankYouMsg = 'PLEASE COUNT YOUR SHIPMENT CAREFULLY THAT THERE ARE NO DAMAGES DUE TO SHIPPING. JAMIS BICYCLES THANKS YOU FOR YOUR ORDER.';

        const contentLines: string[] = [];
        contentLines.push(customerName.toUpperCase());
        if (street) contentLines.push(street.toUpperCase());
        if (city || state || zip) contentLines.push(cityStateZip);
        contentLines.push(''); // spacer
        contentLines.push(`PALLETS: ${palletCount}`);
        contentLines.push(`UNITS: ${units}`);
        contentLines.push(`LOAD: ${loadNumber || 'N/A'}`);
        contentLines.push(''); // spacer

        const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
        doc.setFont('helvetica', 'bold');

        let fontSize = 100;
        const minFontSize = 12;
        let fits = false;

        while (fontSize >= minFontSize && !fits) {
            doc.setFontSize(fontSize);
            doc.setLineHeightFactor(LINE_HEIGHT);
            let totalHeight = margin;

            for (const line of contentLines) {
                if (line === '') {
                    totalHeight += (fontSize * PT_TO_MM) * 0.3;
                } else {
                    const wrapped = doc.splitTextToSize(line, maxWidth);
                    totalHeight += wrapped.length * (fontSize * PT_TO_MM * LINE_HEIGHT);
                }
            }

            const msgFontSize = fontSize * 0.7;
            doc.setFontSize(msgFontSize);
            const msgWrapped = doc.splitTextToSize(thankYouMsg, maxWidth);
            totalHeight += msgWrapped.length * (msgFontSize * PT_TO_MM * LINE_HEIGHT);

            if (totalHeight <= maxHeight) {
                fits = true;
            } else {
                fontSize -= 1;
            }
        }
        return fontSize;
    }, [customerName, street, city, state, zip, palletCount, units, loadNumber, cityStateZip]);

    const pages = useMemo(() => {
        const p = [];
        for (let i = 0; i < palletCount; i++) {
            // INFO LABEL
            p.push(
                <div key={`info-${i}`}
                    className="bg-white rounded-[20px] shadow-2xl overflow-hidden shrink-0 flex flex-col font-sans uppercase text-black"
                    style={{
                        width: '297mm',
                        height: '210mm',
                        padding: '5mm',
                        fontSize: `${fontSizePt}pt`,
                        lineHeight: '1.1',
                        fontWeight: 'bold'
                    }}
                >
                    <div className="font-black tracking-tighter" style={{ fontSize: 'inherit' }}>
                        <p>{customerName.toUpperCase()}</p>
                        {street && <p>{street.toUpperCase()}</p>}
                        {(city || state || zip) && <p>{cityStateZip}</p>}
                    </div>

                    <div className="mt-[0.3em] font-black tracking-tighter" style={{ fontSize: 'inherit' }}>
                        <p>PALLETS: {palletCount}</p>
                        <p>UNITS: {units}</p>
                        <p>LOAD: {loadNumber || 'N/A'}</p>
                    </div>

                    <div className="mt-auto font-bold uppercase" style={{ fontSize: `${fontSizePt * 0.7}pt` }}>
                        <p>PLEASE COUNT YOUR SHIPMENT CAREFULLY THAT THERE ARE NO DAMAGES DUE TO SHIPPING. JAMIS BICYCLES THANKS YOU FOR YOUR ORDER.</p>
                    </div>
                </div>
            );

            // PALLET NUMBER (Only rendered if more than one pallet exists)
            if (palletCount > 1) {
                p.push(
                    <div key={`num-${i}`}
                        className="bg-white rounded-[20px] shadow-2xl overflow-hidden shrink-0 flex items-center justify-center font-sans text-black"
                        style={{
                            width: '297mm',
                            height: '210mm'
                        }}
                    >
                        <div className="flex flex-col items-center justify-center gap-0 w-full px-[5mm]">
                            <span className="text-[8rem] font-black leading-none tracking-[0.3em] text-black uppercase">PALLET</span>
                            <h2 className="font-black leading-none tracking-tighter text-black uppercase w-full text-center" style={{ fontSize: '16rem', whiteSpace: 'nowrap' }}>
                                {i + 1} of {palletCount}
                            </h2>
                        </div>
                    </div>
                );
            }
        }
        return p;
    }, [customerName, street, city, state, zip, palletCount, units, loadNumber, fontSizePt, cityStateZip]);

    return (
        <div className="flex flex-col items-center w-full min-h-full pt-8 px-4 bg-black/95">
            <style dangerouslySetInnerHTML={{
                __html: `
                :root { --preview-scale: 0.22; }
                @media (min-width: 640px) { :root { --preview-scale: 0.28; } }
                @media (min-width: 1024px) { :root { --preview-scale: 0.38; } }
                @media (min-width: 1280px) { :root { --preview-scale: 0.45; } }
                @media (min-width: 1536px) { :root { --preview-scale: 0.52; } }
            `}} />

            <div className="w-full mb-8 text-center shrink-0">
                <h2 className="text-3xl md:text-5xl font-[900] text-white tracking-tighter uppercase animate-soft-in">
                    Order #{orderNumber}
                </h2>
                {completedAt && (
                    <p className="text-white/30 text-sm font-bold mt-2 tracking-wide animate-soft-in">
                        {new Date(completedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}{' Â· '}
                        {new Date(completedAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                    </p>
                )}
            </div>

            <div className="w-full flex-1 flex justify-center pb-32">
                <div
                    className="grid gap-x-12 gap-y-20 justify-center origin-top h-fit"
                    style={{
                        gridTemplateColumns: pages.length <= 1 ? '297mm' : 'repeat(2, 297mm)',
                        transform: 'scale(var(--preview-scale))'
                    }}
                >
                    {pages}
                </div>
            </div>
        </div>
    );
};
